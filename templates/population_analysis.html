{% extends 'base.html' %}

{% block title %}Population Analysis{% endblock %}

{% block content %}
    <div class="container">
        <h1>Population Analysis</h1>

        {% for pop, info in selected_population_info.items() %}
            <p><strong>{{ pop }}:</strong> {{ info }}</p>
        {% endfor %}

        <label for="t2d_filter">Check this to view T2D-associated SNPs:</label>
        <input type="checkbox" id="t2d_filter" onchange="updatePlot()">

        <div id="plots-container"></div> 

        <!-- Region Selection Form -->
        <div class="region-selection">
            <h3>Select Region of Interest</h3>
            <form id="region-form">
                <label for="region_start">Start Position:</label>
                <input type="number" id="region_start" name="region_start" placeholder="e.g., 100000">

                <label for="region_end">End Position:</label>
                <input type="number" id="region_end" name="region_end" placeholder="e.g., 500000">

                <label for="gene_name">Gene Name (optional):</label>
                <input type="text" id="gene_name" name="gene_name" placeholder="e.g., TCF7L2">

                <div class="col-12">
                    <label class="form-label">Select Population(s) for Region Analysis:</label>
                    <div class="btn-group d-flex flex-wrap" role="group" id="population-buttons">
                        {% for pop in ["BEB", "GIH", "ITU", "PJL", "STU"] %}
                            <button type="button" class="btn btn-outline-secondary population-btn m-1" 
                                    data-population="{{ pop }}" onclick="togglePopulation(this)">
                                {{ pop }}
                            </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="selected_populations" name="selected_populations">
                </div>

                <button type="button" onclick="fetchRegionData()">Show Region Graph</button>
                <label for="t2d_region_filter">Show T2D-associated SNPs:</label>
                <input type="checkbox" id="t2d_region_filter" checked onchange="fetchRegionData()">

            </form>
        </div>

        <div class="d-flex justify-content-end mt-3">
            <button type="button" class="btn btn-success" onclick="downloadTajimaD()">Download Tajima's D Data</button>
        </div>

        <div id="region-plot-container"></div> 

        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script>
            let tajimaDData = {{ tajima_d_data | safe }};
            let t2dSnps = {{ t2d_snp_data | safe }};
            let clrData = {{ clr_data | safe }};

            function updatePlot() {
                let showT2D = document.getElementById("t2d_filter").checked;
                let container = document.getElementById("plots-container");
                container.innerHTML = "";


                for (let pop in tajimaDData) {

                    let tajimaTitle = document.createElement("h2");
                    tajimaTitle.innerText = `Tajima's D values over chromosome {{ selected_chromosome }} positions for ${pop}`;
                    container.appendChild(tajimaTitle);

                    let plotDiv = document.createElement("div");
                    plotDiv.id = "plot-" + pop;
                    container.appendChild(plotDiv);

                    let binPositions = tajimaDData[pop].map(d => (d.bin_start + d.bin_end) / 2);
                    let tajimaValues = tajimaDData[pop].map(d => d.tajima_d);

                    let traces = [{
                        x: binPositions,
                        y: tajimaValues,
                        mode: 'lines',
                        name: `Tajima's D - ${pop}`,
                        line: { color: "blue" }
                    }];

                    if (showT2D) {
                        let snpPositions = t2dSnps.map(snp => snp.position);
                        let snpValues = snpPositions.map(pos => {
                            let bin = tajimaDData[pop].find(curr => pos >= curr.bin_start && pos <= curr.bin_end);
                            return bin ? bin.tajima_d : null;
                        });

                        let t2dSnpTrace = {
                            x: snpPositions,
                            y: snpValues,
                            mode: 'markers',
                            text: t2dSnps.map(snp => snp.snp_id),
                            textposition: "top center",
                            marker: {color: 'red', size: 10},
                            name: 'T2D SNPs'
                        };
                        traces.push(t2dSnpTrace);
                    }

                    Plotly.newPlot(plotDiv.id, traces);

                    // CLR plot
                    let clrTitle = document.createElement("h2");
                    clrTitle.innerText = `CLR values over chromosome {{ selected_chromosome }} positions for ${pop}`;
                    container.appendChild(clrTitle);

                    let clrPlotDiv = document.createElement("div");
                    clrPlotDiv.id = "clr-plot-" + pop;
                    container.appendChild(clrPlotDiv);

                    let clrPositions = clrData[pop].map(d => d.position);
                    let clrValues = clrData[pop].map(d => d.clr);

                    let clrTraces = [{
                        x: clrPositions,
                        y: clrValues,
                        mode: 'markers',
                        name: `CLR - ${pop}`,
                        marker: { color: "blue", size: 2 }
                    }];

                    if (showT2D) {
                        let snpPositions = t2dSnps.map(snp => snp.position);
                        let snpValues = snpPositions.map(pos => {
                            let closestClr = clrData[pop].reduce((closest, curr) => {
                                return Math.abs(curr.position - pos) < Math.abs(closest.position - pos) ? curr : closest;
                            }, clrData[pop][0]);
                            return closestClr ? closestClr.clr : null;
                        });

                        let t2dSnpTrace = {
                            x: snpPositions,
                            y: snpValues,
                            mode: 'markers',
                            text: t2dSnps.map(snp => snp.snp_id),
                            textposition: "top center",
                            marker: {color: 'red', size: 4},
                            name: 'T2D SNPs'
                        };
                        clrTraces.push(t2dSnpTrace);
                    }                  

                    Plotly.newPlot(clrPlotDiv.id, clrTraces);
                }
            }

            let selectedPopulations = new Set(); // Store selected populations

            // ðŸ”¹ Function to toggle population selection (affects regional analysis)
            function togglePopulation(button) {
                let pop = button.getAttribute("data-population");

                if (selectedPopulations.has(pop)) {
                    selectedPopulations.delete(pop);
                    button.classList.remove("btn-primary");
                    button.classList.add("btn-outline-primary");
                } else {
                    selectedPopulations.add(pop);
                    button.classList.remove("btn-outline-primary");
                    button.classList.add("btn-primary");
                }

                // Update hidden input field to store selected populations
                document.getElementById("selected_populations").value = Array.from(selectedPopulations).join(",");
            }

            function fetchRegionData() {
                let start = document.getElementById("region_start").value;
                let end = document.getElementById("region_end").value;
                let geneName = document.getElementById("gene_name").value;
                let showT2D = document.getElementById("t2d_region_filter").checked; // Show T2D SNPs in the region plot

                // Convert selected populations Set to an Array
                let selectedPopulationsArray = Array.from(selectedPopulations);
                document.getElementById("selected_populations").value = selectedPopulationsArray.join(",");

                // Construct URL with selected populations
                let url = `/population_analysis_region?start=${start}&end=${end}&gene_name=${geneName}`;
                selectedPopulationsArray.forEach(pop => url += `&selected_population=${pop}`);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("region-plot-container").innerHTML = "<h2>Selected Region Tajima's D</h2>";

                        let colors = ["blue", "green", "purple", "orange", "cyan"];
                        let colorIndex = 0;

                        let combinedTraces = [];

                        for (let pop in data.tajima_d_data) {
                            let plotDiv = document.createElement("div");
                            plotDiv.id = `region-plot-${pop}`;
                            document.getElementById("region-plot-container").appendChild(plotDiv);

                            let binPositions = data.tajima_d_data[pop].map(d => (d.bin_start + d.bin_end) / 2);
                            let tajimaValues = data.tajima_d_data[pop].map(d => d.tajima_d);

                            let lineTrace = {
                                x: binPositions,
                                y: tajimaValues,
                                mode: 'lines',
                                name: `Tajima's D - ${pop}`,
                                line: { color: colors[colorIndex] }
                            };

                            let traces = [lineTrace];

                            // **Ensure only Tajima's D values are included in the combined plot**
                            combinedTraces.push(lineTrace);
                            colorIndex = (colorIndex + 1) % colors.length;

                            // **Map T2D SNPs to their correct Tajima's D bins**
                            if (showT2D && data.t2d_snp_data.length > 0) {
                                let snpPositions = data.t2d_snp_data.map(snp => snp.position);
                                let snpValues = snpPositions.map(pos => {
                                    let bin = data.tajima_d_data[pop].find(curr => pos >= curr.bin_start && pos <= curr.bin_end);
                                    return bin ? bin.tajima_d : null;
                                });

                                let t2dSnpTrace = {
                                    x: snpPositions,
                                    y: snpValues,
                                    mode: 'markers',
                                    text: data.t2d_snp_data.map(snp => snp.snp_id),
                                    textposition: "top center",
                                    marker: { color: 'red', size: 10 },
                                    name: 'T2D SNPs'
                                };
                                traces.push(t2dSnpTrace);
                            }

                            let layout = {
                                title: `Tajima's D for ${pop} (Selected Region)`,
                                xaxis: { title: "Genomic Position (bp)" },
                                yaxis: { title: "Tajima's D" },
                                showlegend: true,
                                height: 600,
                                width: 1000,
                                margin: { l: 50, r: 50, t: 50, b: 50 }
                            };

                            Plotly.newPlot(plotDiv.id, traces, layout);
                            colorIndex = (colorIndex + 1) % colors.length;

                             // âœ… Display mean and standard deviation next to each plot
                            let summaryDiv = document.createElement("div");
                            summaryDiv.innerHTML = `
                                <p><strong>Population:</strong> ${pop}</p>
                                <p><strong>Mean Tajima's D:</strong> ${data.summary_stats[pop].mean}</p>
                                <p><strong>Std Dev Tajima's D:</strong> ${data.summary_stats[pop].std_dev}</p>
                            `;
                            summaryDiv.style.marginBottom = "20px";
                            summaryDiv.style.fontSize = "16px";
                            summaryDiv.style.fontWeight = "bold";
                            
                            document.getElementById("region-plot-container").appendChild(summaryDiv);
                        }

                        // **ðŸ”¥ Final combined plot with all selected populations (WITHOUT T2D SNPs) ðŸ”¥**
                        if (selectedPopulationsArray.length > 1) {
                            let combinedLayout = {
                                title: "Combined Tajima's D for All Selected Populations",
                                xaxis: { title: "Genomic Position (bp)" },
                                yaxis: { title: "Tajima's D" },
                                showlegend: true,
                                height: 600,
                                width: 1200,
                                margin: { l: 50, r: 50, t: 50, b: 50 }
                            };

                            let combinedPlotDiv = document.createElement("div");
                            combinedPlotDiv.id = `region-plot-combined`;
                            document.getElementById("region-plot-container").appendChild(combinedPlotDiv);

                            if (combinedTraces.length > 0) {
                                Plotly.newPlot(combinedPlotDiv.id, combinedTraces, combinedLayout);
                            } else {
                                console.warn("No data found for selected populations in the region. The combined graph will be empty.");
                            }
                        }

                        // CLR plot for selected region 
                        document.getElementById("region-plot-container").innerHTML += "<h2>Selected Region CLR</h2>";

                        for (let pop in data.clr_data) {
                            let clrPlotDiv = document.createElement("div");
                            clrPlotDiv.id = `region-clr-plot-${pop}`;
                            document.getElementById("region-plot-container").appendChild(clrPlotDiv);

                            let clrPositions = data.clr_data[pop].map(d => d.position);
                            let clrValues = data.clr_data[pop].map(d => d.clr);

                            let clrTraces = [{
                                x: clrPositions,
                                y: clrValues,
                                mode: 'markers',
                                name: `CLR - ${pop}`,
                                marker: { color: colors[colorIndex] }
                            }];

                            if (showT2D) {
                                let snpPositions = data.t2d_snp_data.map(snp => snp.position);
                                let snpValues = snpPositions.map(pos => {
                                    let closestClr = data.clr_data[pop].reduce((closest, curr) => {
                                        return Math.abs(curr.position - pos) < Math.abs(closest.position - pos) ? curr : closest;
                                    }, data.clr_data[pop][0]);
                                    return closestClr ? closestClr.clr : null;
                                });

                                let t2dSnpTrace = {
                                    x: snpPositions,
                                    y: snpValues,
                                    mode: 'markers',
                                    text: data.t2d_snp_data.map(snp => snp.snp_id),
                                    textposition: "top center",
                                    marker: { color: 'red', size: 4 },
                                    name: 'T2D SNPs'
                                };
                                clrTraces.push(t2dSnpTrace);
                            }

                            let clrLayout = {
                                title: `CLR for ${pop} (Selected Region)`,
                                xaxis: { title: "Genomic Position (bp)" },
                                yaxis: { title: "CLR" },
                                showlegend: true,
                                height: 600,
                                width: 1000,
                                margin: { l: 50, r: 50, t: 50, b: 50 }
                            };

                            Plotly.newPlot(clrPlotDiv.id, clrTraces, clrLayout);
                            colorIndex = (colorIndex + 1) % colors.length;

                            // âœ… Display mean and standard deviation next to each plot
                            let clrSummaryDiv = document.createElement("div");
                            clrSummaryDiv.innerHTML = `
                                <p><strong>Population:</strong> ${pop}</p>
                                <p><strong>Mean CLR:</strong> ${data.clr_summary_stats[pop].mean}</p>
                                <p><strong>Std Dev CLR:</strong> ${data.clr_summary_stats[pop].std_dev}</p>
                            `;
                            clrSummaryDiv.style.marginBottom = "20px";
                            clrSummaryDiv.style.fontSize = "16px";
                            clrSummaryDiv.style.fontWeight = "bold";
                            
                            document.getElementById("region-plot-container").appendChild(clrSummaryDiv);
                        }
                        
                    });
                }

                function downloadTajimaD() {
                    let start = document.getElementById("region_start").value.trim();
                    let end = document.getElementById("region_end").value.trim();
                    let geneName = document.getElementById("gene_name").value.trim();
                    let chromosome = "{{ selected_chromosome }}"; 
                    let selectedPopulationsArray = Array.from(selectedPopulations);

                    if (selectedPopulationsArray.length === 0) {
                        alert("Please select at least one population before downloading.");
                        return;
                    }

                    // Construct the download URL
                    let url = `/download_tajima_d?chromosome=${chromosome}`;
                    
                    if (geneName) {
                        url += `&gene_name=${encodeURIComponent(geneName)}`;
                    } else if (start && end) {
                        url += `&start=${start}&end=${end}`;
                    } else {
                        alert("Please enter either a start and end position OR a gene name.");
                        return;
                    }

                    selectedPopulationsArray.forEach(pop => url += `&selected_population=${pop}`);

                    // Create an invisible anchor tag to force the browser to download the file
                    let link = document.createElement("a");
                    link.href = url;
                    link.setAttribute("download", `TajimaD_chr${chromosome}_${start || geneName}_${end || ""}.txt`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

            updatePlot();
        </script>
    </div>
{% endblock %}